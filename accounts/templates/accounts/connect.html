{% extends "base.html" %}
{% load static %}

{% block content %}
<section class="section-container" style="margin-top:2rem;">
  <div class="profile-section">
    <div class="section-header">
      <h2><i class="fas fa-user-friends"></i> Connect with Students</h2>
    </div>

    <div class="section-content">
      <div class="tabs" style="display:flex; gap:.5rem; margin-bottom:1rem;">
        <a href="?tab=find" class="btn {% if tab == 'find' %}btn-primary{% else %}btn-outline-nav{% endif %}">
          <i class="fas fa-user-plus"></i> Find New Friends
          <span class="section-badge" style="margin-left:.5rem;">{{ counts.find|default:0 }}</span>
        </a>

        <a href="?tab=friends" class="btn {% if tab == 'friends' %}btn-primary{% else %}btn-outline-nav{% endif %}">
          <i class="fas fa-user-check"></i> Your Friends
          <span class="section-badge" style="margin-left:.5rem;">{{ counts.friends|default:0 }}</span>
        </a>

        <a href="?tab=pending" class="btn {% if tab == 'pending' %}btn-primary{% else %}btn-outline-nav{% endif %}">
          <i class="fas fa-inbox"></i> Pending
          <span class="section-badge" style="margin-left:.5rem;">
            {{ counts.pending_in|default:0 }}/{{ counts.pending_out|default:0 }}
          </span>
        </a>
      </div>

      {% if tab == 'find' %}
        <form method="get" class="auth-form" style="margin-bottom:1.5rem;">
          <input type="hidden" name="tab" value="find">
          <div class="form-group">
            <label class="form-label" for="q">Search by name, username, or email</label>
            <input id="q" name="q" type="text"
                   placeholder="e.g., Alice, Bob Chen, bob@example.edu"
                   value="{{ query }}"
                   class="auth-form-input" style="width:100%; padding:.75rem;">
          </div>
          <div class="section-cta">
            <button type="submit" class="btn btn-primary btn-lg">
              <i class="fas fa-search"></i> Search
            </button>
          </div>
        </form>

        {# --- MAP UI (safe for Django templating) --- #}
        <div class="section-header-inline" style="display:flex; align-items:center; justify-content:space-between; gap:1rem; margin:1rem 0 0.75rem;">
          <h3><i class="fas fa-map-marked-alt"></i> Nearby students</h3>
          {% if has_map_data %}
          <span class="section-badge" id="map-debug-badge" style="background:#22c55e;">
          {% else %}
          <span class="section-badge" id="map-debug-badge" style="background:#ef4444;">
          {% endif %}
            {% if GOOGLE_MAPS_API_KEY %}
              {% if has_map_data %}Map ready ({{ users|length }} users){% else %}No mappable users{% endif %}
            {% else %}
              Missing GOOGLE_MAPS_API_KEY
            {% endif %}
          </span>
        </div>

        <div id="find-map-wrap" style="background:#fff;border:1px solid var(--border-color);border-radius:16px;box-shadow:var(--shadow-sm);overflow:hidden;margin-bottom:1.25rem;">
          <div id="find-map" style="width:100%; height:360px;"></div>
          {% if has_map_data %}
          <div id="find-map-empty" style="display:none; padding:1rem; color:var(--text-secondary); text-align:center;">
          {% else %}
          <div id="find-map-empty" style="display:block; padding:1rem; color:var(--text-secondary); text-align:center;">
          {% endif %}
            {% if not GOOGLE_MAPS_API_KEY %}
              <strong>Map disabled:</strong> add <code>GOOGLE_MAPS_API_KEY</code> to settings/env and allow <code>http://localhost:8000</code> or <code>http://127.0.0.1:8000</code> in Google Maps API referrer restrictions.
            {% else %}
              No users with valid coordinates (or they are marked "Remote"). Try adding your study location/coordinates in your profile, or widen your search.
            {% endif %}
          </div>
        </div>

        {% if GOOGLE_MAPS_API_KEY %}
          <script>
            // Parse markers coming from Django safely (no backticks)
            var USER_MARKERS = (function(){
              try { return JSON.parse('{{ user_markers_json|escapejs }}'); }
              catch(e){ console.error('Marker parse error', e); return []; }
            })();

            function initFindMap(){
              try {
                var hasData = Array.isArray(USER_MARKERS) && USER_MARKERS.length > 0;
                var mapEl = document.getElementById('find-map');
                if (!mapEl) return;

                // Fallback center (Georgia Tech)
                var fallbackCenter = { lat: 33.7756, lng: -84.3963 };

                var startCenter = hasData ? { lat: USER_MARKERS[0].lat, lng: USER_MARKERS[0].lng } : fallbackCenter;
                var startZoom   = hasData ? 12 : 11;

                var map = new google.maps.Map(mapEl, {
                  center: startCenter,
                  zoom:   startZoom,
                  mapTypeControl: false,
                  streetViewControl: false,
                  fullscreenControl: true
                });

                if (!hasData) return;

                var info   = new google.maps.InfoWindow();
                var bounds = new google.maps.LatLngBounds();

                USER_MARKERS.forEach(function(m){
                  var pos = { lat: m.lat, lng: m.lng };
                  var marker = new google.maps.Marker({
                    position: pos,
                    map: map,
                    title: m.username
                  });
                  bounds.extend(pos);

                  // Build popup HTML using classic string concat (no template literals)
                  var safeUser  = String(m.username || '').replace(/</g,'&lt;');
                  var safeLoc   = String(m.study_location || '').replace(/</g,'&lt;');
                  var eta       = (m.drive_minutes != null)  ? (m.drive_minutes + ' min') : '‚Äî';
                  var dist      = (m.distance_miles != null) ? (m.distance_miles + ' mi') : '‚Äî';

                  var html  = '<div style="min-width:220px;max-width:280px;">';
                      html += '  <div style="display:flex;gap:10px;align-items:center;">';
                      html += '    <img src="' + m.avatar + '" alt="' + safeUser + '" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">';
                      html += '    <div><strong>' + safeUser + '</strong><br/>';
                      html += '      <small style="color:#64748b;">' + safeLoc + '</small>';
                      html += '    </div>';
                      html += '  </div>';
                      html += '  <div style="margin-top:8px;color:#334155;font-size:.95rem;">';
                      html += '    <span style="display:inline-block;margin-right:10px;">üöó ' + eta  + '</span>';
                      html += '    <span>üìç ' + dist + '</span>';
                      html += '  </div>';
                      html += '</div>';

                  marker.addListener('click', function(){
                    info.setContent(html);
                    info.open({ anchor: marker, map: map });
                  });
                });

                if (!bounds.isEmpty()) {
                  map.fitBounds(bounds, 64);
                }
              } catch (err) {
                console.error('initFindMap error:', err);
                var badge = document.getElementById('map-debug-badge');
                if (badge) { badge.textContent = 'Map init failed'; badge.style.background = '#ef4444'; }
              }
            }

            // Expose global for Google callback
            window.initFindMap = initFindMap;
          </script>

          <script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initFindMap" async defer></script>
        {% endif %}

        <h3 style="margin:1rem 0;">Suggestions ({{ users|length }})</h3>
        {% if users %}
          <div class="action-cards">
            {% for u in users %}
            <div class="action-card">
              <div class="action-icon"><i class="fas fa-user"></i></div>
              <div class="action-content">
                <h3>{{ u.username }}</h3>
                <p style="color:var(--text-secondary); margin-top:.25rem;">
                  {% if u.first_name or u.last_name %}
                    {{ u.first_name }} {{ u.last_name }}
                  {% else %}
                    Student
                  {% endif %}
                  {% if u.email %} ‚Ä¢ {{ u.email }}{% endif %}
                  {% if u.distance_miles %} ‚Ä¢ ~{{ u.distance_miles }} mi{% endif %}
                  {% if u.drive_minutes %} ‚Ä¢ ~{{ u.drive_minutes }} min{% endif %}
                </p>
              </div>
              <a href="{% url 'accounts:connect_request' u.id %}" class="btn btn-primary">
                <i class="fas fa-user-plus"></i> Connect
              </a>
            </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="empty-profile">
            <div class="empty-icon"><i class="far fa-smile"></i></div>
            <h2>No suggestions found</h2>
            <p>Try a different search or invite more friends!</p>
          </div>
        {% endif %}
      {% endif %}

      {% if tab == 'friends' %}
        <h3 style="margin:1rem 0;">Your Friends ({{ friends|length }})</h3>
        {% if friends %}
          <div class="action-cards">
            {% for f in friends %}
            <div class="action-card">
              <div class="action-icon"><i class="fas fa-user-check"></i></div>
              <div class="action-content">
                <h3>{{ f.username }}</h3>
                <p style="color:var(--text-secondary); margin-top:.25rem;">
                  {% if f.first_name or f.last_name %}
                    {{ f.first_name }} {{ f.last_name }}
                  {% else %}
                    Student
                  {% endif %}
                  {% if f.email %} ‚Ä¢ {{ f.email }}{% endif %}
                </p>
              </div>
              <span class="section-badge" style="margin-left:auto;">Connected</span>
            </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="empty-state">You haven't connected with anyone yet.</div>
        {% endif %}
      {% endif %}

      {% if tab == 'pending' %}
        <div class="grid" style="display:grid; gap:1rem;">
          <div>
            <h3 style="margin:1rem 0;">Incoming Requests ({{ incoming|length|default:0 }})</h3>
            {% if incoming %}
              <div class="action-cards">
                {% for fr in incoming %}
                  <div class="action-card">
                    <div class="action-icon"><i class="fas fa-inbox"></i></div>
                    <div class="action-content">
                      <h3>{{ fr.from_user.username }}</h3>
                      <p style="color:var(--text-secondary); margin-top:.25rem;">
                        sent {{ fr.created_at }}
                      </p>
                    </div>
                    <form method="post" action="{% url 'accounts:connect_accept' fr.id %}" style="margin-right:.5rem;">
                      {% csrf_token %}
                      <button class="btn btn-primary"><i class="fas fa-check"></i> Accept</button>
                    </form>
                    <form method="post" action="{% url 'accounts:connect_decline' fr.id %}">
                      {% csrf_token %}
                      <button class="btn btn-outline-nav"><i class="fas fa-times"></i> Decline</button>
                    </form>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="empty-state">No incoming requests.</div>
            {% endif %}
          </div>

          <div>
            <h3 style="margin:1rem 0;">Outgoing Requests ({{ outgoing|length|default:0 }})</h3>
            {% if outgoing %}
              <div class="action-cards">
                {% for fr in outgoing %}
                  <div class="action-card">
                    <div class="action-icon"><i class="far fa-paper-plane"></i></div>
                    <div class="action-content">
                      <h3>{{ fr.to_user.username }}</h3>
                      <p style="color:var(--text-secondary); margin-top:.25rem;">
                        requested {{ fr.created_at }}
                      </p>
                    </div>
                    <form method="post" action="{% url 'accounts:connect_cancel' fr.id %}">
                      {% csrf_token %}
                      <button class="btn btn-outline-nav"><i class="fas fa-ban"></i> Cancel</button>
                    </form>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="empty-state">No outgoing requests.</div>
            {% endif %}
          </div>

          <div class="empty-actions" style="margin-top:.5rem;">
            <a href="{% url 'accounts:connect' %}?tab=find" class="btn btn-secondary">Back to Find</a>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</section>
{% endblock %}