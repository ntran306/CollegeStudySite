{% extends "base.html" %}
{% load static %}

{% block content %}

<!-- =========================
     Hero
========================== -->
<section class="hero">
  <div class="hero-overlay"></div>
  <div class="hero-container">
    <div class="hero-content">
      <div class="hero-badge">
        <i class="fas fa-chalkboard-teacher"></i>
        <span>Find a session that fits you</span>
      </div>
      <h1 class="hero-title">Browse Tutoring Sessions</h1>
      <p class="hero-subtitle">
        Filter by subject, tutor, location (or “remote”), date, time, and capacity type. Click request to join.
      </p>

      <div class="hero-cta">
        <a href="#filters" class="btn btn-primary btn-hero">
          <i class="fas fa-search"></i>
          <span>Search Sessions</span>
        </a>
        <a href="{% url 'tutoringsession:friends_sessions' %}" class="btn btn-secondary btn-hero">
          <i class="fas fa-user-friends"></i>
          <span>Friends’ Sessions</span>
        </a>
      </div>
    </div>
  </div>
</section>

<!-- =========================
     Filters
========================== -->
<section id="filters" class="section-container" style="margin-top:-3rem;">
  <div class="profile-section">
    <div class="section-header">
      <h2><i class="fas fa-sliders-h"></i> Search Filters</h2>
    </div>
    <div class="section-content">
      <form method="get" class="auth-form" style="margin:0;">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="subject">Subject</label>
            <input id="subject" name="subject" type="text" class="auth-form-input"
                   value="{{ selected.subject }}" placeholder="e.g., CS 1332, Calculus II">
          </div>

          <div class="form-group">
            <label class="form-label" for="tutor">Tutor</label>
            <input id="tutor" name="tutor" type="text" class="auth-form-input"
                   value="{{ selected.tutor }}" placeholder="Username or name">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="location">Location</label>
            <input id="location" name="location" type="text" class="auth-form-input"
                   value="{{ selected.location }}" placeholder="Campus, library, or 'remote'">
            <div class="form-help"><i class="fas fa-info-circle"></i> Use “remote” or “online” to see virtual sessions.</div>
          </div>

          <div class="form-group">
            <label class="form-label" for="date">Date</label>
            <input id="date" name="date" type="date" class="auth-form-input" value="{{ selected.date }}">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="time">Time</label>
            <input id="time" name="time" type="text" class="auth-form-input"
                   value="{{ selected.time }}" placeholder="HH:MM or 3:30 PM">
            <div class="form-help"><i class="fas fa-info-circle"></i> Matches sessions whose time range contains this time; sessions with blank times count as “any time”.</div>
          </div>

          <div class="form-group">
            <label class="form-label" for="capacity_type">Capacity</label>
            <select id="capacity_type" name="capacity_type" class="auth-form-input">
              <option value="">Any capacity</option>
              <option value="one_on_one" {% if selected.capacity_type == 'one_on_one' %}selected{% endif %}>1-on-1</option>
              <option value="group" {% if selected.capacity_type == 'group' %}selected{% endif %}>Group</option>
            </select>
          </div>
        </div>

        <div class="form-options" style="margin-top:.5rem;">
          <label class="checkbox-label">
            <input type="checkbox" name="include_full" value="1" {% if selected.include_full == '1' %}checked{% endif %}>
            Include full sessions
          </label>
          <div>
            <button class="btn btn-primary btn-lg" type="submit">
              <i class="fas fa-search"></i> Search
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</section>

<!-- =========================
     Map
========================== -->
{% if GOOGLE_MAPS_API_KEY %}
<section class="section-container">
  <div class="profile-section">
    <div class="section-header" style="display:flex; align-items:center; justify-content:space-between; gap:1rem;">
      <h2 style="margin:0;"><i class="fas fa-map-marker-alt"></i> Map</h2>

      <!-- Map controls (reuses your button/input styles via CSS vars) -->
      <div class="form-row" style="margin:0; display:flex; align-items:center; gap:.75rem;">
        <label class="form-label" for="radius-miles" style="margin:0;">Radius (mi)</label>
        <input id="radius-miles" type="number" step="0.1" min="0.1" value="3"
               class="auth-form-input" style="width:6.5rem; padding:.4rem .6rem;">
        <button id="use-my-location" class="btn btn-secondary" type="button" title="Center to my location">
          <i class="fas fa-location-arrow"></i> Use my location
        </button>
      </div>
    </div>

    <div class="section-content">
      <div id="map"
           style="width:100%; height:380px; border-radius: var(--radius-lg); box-shadow: var(--shadow-md); border:1px solid var(--border-color);"></div>
    </div>
  </div>
</section>
{% endif %}

<!-- =========================
     Results
========================== -->
<section class="section-container">
  <div class="profile-section">
    <div class="section-header">
      <h2><i class="fas fa-list"></i> Sessions <span style="color:var(--text-secondary); font-weight:600;">({{ sessions|length }})</span></h2>
    </div>

    <div class="section-content">
      {% if sessions %}
        <div class="action-cards">
          {% for s in sessions %}
            <div id="session-{{ s.id }}" class="action-card">
              <div class="action-icon">
                <i class="fas fa-book-open"></i>
              </div>

              <div class="action-content">
                <h3>
                  {{ s.subject }}
                  {% if s.capacity == 1 %}
                    <span class="section-badge" style="margin-left:.5rem;">1-on-1</span>
                  {% else %}
                    <span class="section-badge" style="margin-left:.5rem;">Group ({{ s.capacity }})</span>
                  {% endif %}
                  {% if s.is_remote %}
                    <span class="section-badge" style="margin-left:.5rem; background:var(--bg-secondary); color:var(--text-secondary);">Remote</span>
                  {% endif %}
                </h3>

                <p style="margin-top:.35rem;">
                  <span style="color:var(--text-secondary);">
                    <i class="far fa-calendar"></i> {{ s.date }}
                    &nbsp;&nbsp; <i class="far fa-clock"></i>
                    {% if s.start_time %}{{ s.start_time }}{% else %}Any{% endif %}
                    –
                    {% if s.end_time %}{{ s.end_time }}{% else %}Any{% endif %}
                    &nbsp;&nbsp; <i class="fas fa-map-marker-alt"></i> {{ s.location }}
                    &nbsp;&nbsp; <i class="fas fa-chalkboard-teacher"></i> {{ s.tutor.username }}
                    &nbsp;&nbsp; <i class="fas fa-users"></i> {{ s.seats_taken }} / {{ s.capacity }}
                  </span>
                </p>

                {% if s.description %}
                  <p style="margin-top:.35rem; color:var(--text-light);">{{ s.description }}</p>
                {% endif %}
              </div>

              <i class="fas fa-arrow-right action-arrow"></i>

              <div class="profile-actions" style="margin-left:auto;">
                {% if s.is_full %}
                  <button class="btn btn-outline-nav" disabled>Full</button>
                {% else %}
                  {% if user.is_authenticated %}
                    <form method="post" action="{% url 'tutoringsession:request_session' s.id %}">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-primary">
                        <i class="fas fa-hand-paper"></i> Request Session
                      </button>
                    </form>
                  {% else %}
                    <a class="btn btn-primary" href="{% url 'accounts:login' %}?next={% url 'tutoringsession:index' %}">
                      Log in to request
                    </a>
                  {% endif %}
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="empty-profile" style="padding:3rem 1.5rem;">
          <div class="empty-icon"><i class="far fa-calendar-times"></i></div>
          <h2>No sessions match your filters</h2>
          <p>Try broadening your search (different date/time or remove “Include full”).</p>
          <div class="empty-actions">
            <a href="{% url 'tutoringsession:index' %}" class="btn btn-secondary">Clear Filters</a>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</section>

{% if GOOGLE_MAPS_API_KEY %}
  {{ markers|json_script:"session-markers" }}
{% endif %}

{% endblock %}

{% block extra_js %}
{% if GOOGLE_MAPS_API_KEY %}
<script>
(function () {
  const MILES_TO_METERS = 1609.344;
  let map, blueCircle, userMarker;

  function drawCircle(center, miles) {
    const radiusMeters = (parseFloat(miles) || 0) * MILES_TO_METERS;
    if (blueCircle) blueCircle.setMap(null);
    blueCircle = new google.maps.Circle({
      map,
      center,
      radius: radiusMeters > 0 ? radiusMeters : 0,
      strokeColor: '#1e3a8a',
      strokeOpacity: 0.8,
      strokeWeight: 1,
      fillColor: '#3b82f6',
      fillOpacity: 0.15,
    });
  }

  function setUserMarker(center) {
    if (!userMarker) {
      userMarker = new google.maps.Marker({
        map,
        position: center,
        title: 'Selected Center',
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 6,
          strokeColor: '#2563eb',
          fillColor: '#2563eb',
          fillOpacity: 1
        }
      });
    } else {
      userMarker.setPosition(center);
    }
  }

  function highlightListItem(id) {
    const li = document.getElementById("session-" + id);
    if (li) {
      li.scrollIntoView({ behavior: "smooth", block: "center" });
      li.style.boxShadow = "0 0 0 3px rgba(37, 99, 235, 0.25)";
      setTimeout(() => (li.style.boxShadow = ""), 1200);
    }
  }

  function init() {
    const dataEl = document.getElementById("session-markers");
    const markers = dataEl ? JSON.parse(dataEl.textContent) : [];
    const mapEl = document.getElementById("map");
    if (!mapEl) return;

    const fallback = { lat: 33.7756, lng: -84.3963 }; // GT campus
    const initialCenter = markers.length ? { lat: markers[0].lat, lng: markers[0].lng } : fallback;

    map = new google.maps.Map(mapEl, {
      center: initialCenter,
      zoom: markers.length ? 12 : 11,
      mapTypeControl: false,
      streetViewControl: false,
      fullscreenControl: true
    });

    // Blue circle initial state (based on control)
    const radiusInput = document.getElementById('radius-miles');
    setUserMarker(initialCenter);
    drawCircle(initialCenter, radiusInput ? radiusInput.value : 3);

    // “Use my location”
    const useMyLocBtn = document.getElementById('use-my-location');
    useMyLocBtn?.addEventListener('click', () => {
      if (!navigator.geolocation) return;
      navigator.geolocation.getCurrentPosition((pos) => {
        const c = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        map.panTo(c);
        setUserMarker(c);
        drawCircle(c, radiusInput ? radiusInput.value : 3);
      });
    });

    // Update circle when radius changes
    radiusInput?.addEventListener('input', (e) => {
      const center = userMarker?.getPosition() || map.getCenter();
      drawCircle(center, e.target.value);
    });

    // --- Advanced avatar markers for sessions ---
    const bounds = new google.maps.LatLngBounds();
    const info = new google.maps.InfoWindow();
    const { AdvancedMarkerElement } = google.maps.marker || {};
    const useAdvanced = Boolean(AdvancedMarkerElement);

    markers.forEach(m => {
      const position = { lat: m.lat, lng: m.lng };

      let markerObj;
      if (useAdvanced) {
        // Build pill with avatar + name
        const pin = document.createElement("div");
        pin.style.cssText = `
          display:flex; align-items:center; gap:6px; padding:4px 8px;
          background:var(--bg-elevated, #fff); border:1px solid var(--border-color, #e5e7eb);
          border-radius:999px; box-shadow:var(--shadow-sm, 0 1px 2px rgba(0,0,0,.08));
          transform:translateY(-6px);
        `;

        const img = document.createElement("img");
        img.src = m.avatar || "{% static 'img/avatar-default.png' %}";
        img.alt = (m.tutor || "Tutor");
        img.referrerPolicy = "no-referrer";
        img.style.cssText = "width:24px; height:24px; border-radius:999px; object-fit:cover;";
        pin.appendChild(img);

        const label = document.createElement("span");
        label.textContent = m.tutor || "";
        label.style.cssText = "font-size:12px; font-weight:600; color:var(--text, #111827);";
        pin.appendChild(label);

        markerObj = new AdvancedMarkerElement({
          map,
          position,
          content: pin,
          title: m.title || m.tutor
        });

        markerObj.addListener("gmp-click", () => {
          info.setContent(`
            <div style="min-width:220px; display:flex; gap:10px; align-items:center;">
              <img src="${m.avatar || ''}" alt="${m.tutor || 'Tutor'}"
                   style="width:40px;height:40px;border-radius:50%;object-fit:cover;">
              <div>
                <strong>${m.title ?? ''}</strong><br>
                <small>${m.location ?? ''}</small><br>
                <small>Tutor: ${m.tutor ?? ''} • ${m.date ?? ''}</small><br>
                <a href="#session-${m.id}">View in list</a>
              </div>
            </div>
          `);
          info.open(map, markerObj);
          highlightListItem(m.id);
        });
      } else {
        // Fallback to default Marker if Advanced markers not available
        markerObj = new google.maps.Marker({
          map,
          position,
          title: m.title || m.tutor
        });
        markerObj.addListener("click", () => {
          info.setContent(`
            <div style="min-width:200px;">
              <strong>${m.title ?? ''}</strong><br>
              <small>${m.location ?? ''}</small><br>
              <small>Tutor: ${m.tutor ?? ''} • ${m.date ?? ''}</small><br>
              <a href="#session-${m.id}">View in list</a>
            </div>
          `);
          info.open(map, markerObj);
          highlightListItem(m.id);
        });
      }

      bounds.extend(position);
    });

    if (markers.length > 1) map.fitBounds(bounds);
  }

  window.__initSessionsMap = init;
})();
</script>

<!-- Need Marker Library -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&libraries=marker&callback=__initSessionsMap"></script>
{% endif %}
{% endblock %}