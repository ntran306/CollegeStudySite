{% extends "base.html" %}
{% load static %}
{% load session_filters %}

{% block content %}

<!-- =========================
     Hero
========================== -->
<section class="hero">
  <div class="hero-overlay"></div>
  <div class="hero-container">
    <div class="hero-content">
      <div class="hero-badge">
        <i class="fas fa-chalkboard-teacher"></i>
        <span>Find a session that fits you</span>
      </div>
      <h1 class="hero-title">Browse Tutoring Sessions</h1>
      <p class="hero-subtitle">
        Filter by subject, tutor, location (or "remote"), date, time, and capacity type. Click request to join.
      </p>

      <div class="hero-cta">
        <a href="#filters" class="btn btn-primary btn-hero">
          <i class="fas fa-search"></i>
          <span>Search Sessions</span>
        </a>
        <a href="{% url 'accounts:connect' %}" class="btn btn-secondary btn-hero">
          <i class="fas fa-user-friends"></i>
          <span>Connect</span>
        </a>
      </div>
    </div>
  </div>
</section>

<!-- =========================
     Filters
========================== -->
<section id="filters" class="section-container" style="margin-top:-3rem;">
  <div class="profile-section">
    <div class="section-header">
      <h2><i class="fas fa-sliders-h"></i> Search Filters</h2>
    </div>
    <div class="section-content">
      <form method="get" class="auth-form" style="margin:0;">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="subject">Subject</label>
            <input id="subject" name="subject" type="text" class="auth-form-input"
                   value="{{ selected.subject }}" placeholder="e.g., CS 1332, Calculus II">
          </div>

          <div class="form-group">
            <label class="form-label" for="tutor">Tutor</label>
            <input id="tutor" name="tutor" type="text" class="auth-form-input"
                   value="{{ selected.tutor }}" placeholder="Username or name">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="location">Location</label>
            <input id="location" name="location" type="text" class="auth-form-input"
                   value="{{ selected.location }}" placeholder="Campus, library, or 'remote'">
            <div class="form-help"><i class="fas fa-info-circle"></i> Use "remote" or "online" to see virtual sessions.</div>
          </div>

          <div class="form-group">
            <label class="form-label" for="date">Date</label>
            <input id="date" name="date" type="date" class="auth-form-input" value="{{ selected.date }}" style="font-family: inherit;">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="time">Time</label>
            <input id="time" name="time" type="text" class="auth-form-input"
                   value="{{ selected.time }}" placeholder="HH:MM or 3:30 PM">
            <div class="form-help"><i class="fas fa-info-circle"></i> Matches sessions whose time range contains this time; sessions with blank times count as "any time".</div>
          </div>

          <div class="form-group">
            <label class="form-label" for="capacity_type">Capacity</label>
            <select id="capacity_type" name="capacity_type" class="auth-form-input">
              <option value="">Any capacity</option>
              <option value="one_on_one" {% if selected.capacity_type == 'one_on_one' %}selected{% endif %}>1-on-1</option>
              <option value="group" {% if selected.capacity_type == 'group' %}selected{% endif %}>Group</option>
            </select>
          </div>
        </div>

        <div class="form-options" style="margin-top:.5rem;">
          <label class="checkbox-label">
            <input type="checkbox" name="include_full" value="1" {% if selected.include_full == '1' %}checked{% endif %}>
            Include full sessions
          </label>
          <div>
            <button class="btn btn-primary btn-lg" type="submit">
              <i class="fas fa-search"></i> Search
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</section>

<!-- =========================
     Map Section
========================== -->
<section class="section-container" style="margin-top:1rem;">
  <div class="profile-section">
    <div class="section-header-inline" style="display:flex; align-items:center; justify-content:space-between; gap:1rem; margin:2rem; padding-left: 1rem;">
      <h2><i class="fas fa-map-marked-alt"></i> Nearby Sessions</h2>
      {% if has_map_data %}
      <span class="section-badge" id="map-debug-badge" style="background:#22c55e;">
      {% else %}
      <span class="section-badge" id="map-debug-badge" style="background:#ef4444;">
      {% endif %}
        {% if GOOGLE_MAPS_API_KEY %}
          {% if has_map_data %}Map ready ({{ sessions|length }} sessions){% else %}No mappable sessions{% endif %}
        {% else %}
          Missing GOOGLE_MAPS_API_KEY
        {% endif %}
      </span>
    </div>

    <div class="section-content">
      <div id="session-map-wrap" style="background:#fff;border:1px solid var(--border-color);border-radius:16px;box-shadow:var(--shadow-sm);overflow:hidden;margin-bottom:1.25rem;">
        <div id="session-map" style="width:100%; height:420px;"></div>
        {% if has_map_data %}
        <div id="session-map-empty" style="display:none; padding:1rem; color:var(--text-secondary); text-align:center;">
        {% else %}
        <div id="session-map-empty" style="display:block; padding:1rem; color:var(--text-secondary); text-align:center;">
        {% endif %}
          {% if not GOOGLE_MAPS_API_KEY %}
            <strong>Map disabled:</strong> add <code>GOOGLE_MAPS_API_KEY</code> to settings/env and allow your domain in Google Maps API referrer restrictions.
          {% else %}
            No sessions with valid coordinates (or they are marked "Remote"). Try adding location/coordinates to sessions, or widen your search.
          {% endif %}
        </div>
      </div>

      {% if GOOGLE_MAPS_API_KEY %}
        <script>
          // Parse markers coming from Django safely (no backticks)
          var SESSION_MARKERS = (function(){
            try { return JSON.parse('{{ user_markers_json|escapejs }}'); }
            catch(e){ console.error('Marker parse error', e); return []; }
          })();

          function initSessionMap(){
            try {
              var hasData = Array.isArray(SESSION_MARKERS) && SESSION_MARKERS.length > 0;
              var mapEl = document.getElementById('session-map');
              if (!mapEl) return;

              // Fallback center (Georgia Tech)
              var fallbackCenter = { lat: 33.7756, lng: -84.3963 };

              var startCenter = hasData ? { lat: SESSION_MARKERS[0].lat, lng: SESSION_MARKERS[0].lng } : fallbackCenter;
              var startZoom   = hasData ? 12 : 11;

              var map = new google.maps.Map(mapEl, {
                center: startCenter,
                zoom:   startZoom,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: true
              });

              if (!hasData) return;

              var info   = new google.maps.InfoWindow();
              var bounds = new google.maps.LatLngBounds();

              SESSION_MARKERS.forEach(function(m){
                var pos = { lat: m.lat, lng: m.lng };
                var marker = new google.maps.Marker({
                  position: pos,
                  map: map,
                  title: m.title,
                  icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 10,
                    fillColor: '#3b82f6',
                    fillOpacity: 0.9,
                    strokeColor: '#1e40af',
                    strokeWeight: 2
                  }
                });
                bounds.extend(pos);

                // Build popup HTML using classic string concat (no template literals)
                var safeTitle = String(m.title || '').replace(/</g,'&lt;');
                var safeLoc   = String(m.location || '').replace(/</g,'&lt;');
                var safeTutor = String(m.tutor || '').replace(/</g,'&lt;');
                var dist      = (m.distance_miles != null) ? (m.distance_miles + ' mi') : '';

                var html  = '<div style="min-width:220px;max-width:280px;">';
                    html += '  <div style="display:flex;gap:10px;align-items:center;">';
                    html += '    <img src="' + m.avatar + '" alt="' + safeTutor + '" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">';
                    html += '    <div><strong>' + safeTitle + '</strong><br/>';
                    html += '      <small style="color:#64748b;">' + safeLoc + '</small>';
                    html += '    </div>';
                    html += '  </div>';
                    html += '  <div style="margin-top:8px;color:#334155;font-size:.95rem;">';
                    html += '    <span style="display:inline-block;margin-right:10px;">üë®‚Äçüè´ ' + safeTutor  + '</span>';
                    if (dist) {
                      html += '    <span>üìç ' + dist + '</span>';
                    }
                    html += '  </div>';
                    html += '  <div style="margin-top:8px;">';
                    html += '    <a href="#session-' + m.id + '" style="color:#3b82f6;text-decoration:none;font-weight:500;">View details ‚Üí</a>';
                    html += '  </div>';
                    html += '</div>';

                marker.addListener('click', function(){
                  info.setContent(html);
                  info.open({ anchor: marker, map: map });
                  
                  // Scroll to session card
                  var card = document.getElementById('session-' + m.id);
                  if (card) {
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    card.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.3)';
                    setTimeout(function() {
                      card.style.boxShadow = '';
                    }, 2000);
                  }
                });
              });

              if (!bounds.isEmpty()) {
                map.fitBounds(bounds, 64);
              }
            } catch (err) {
              console.error('initSessionMap error:', err);
              var badge = document.getElementById('map-debug-badge');
              if (badge) { badge.textContent = 'Map init failed'; badge.style.background = '#ef4444'; }
            }
          }

          // Expose global for Google callback
          window.initSessionMap = initSessionMap;
        </script>

        <script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initSessionMap" async defer></script>
      {% endif %}
    </div>
  </div>
</section>

<!-- =========================
     Results
========================== -->
<section class="section-container" style="margin-top:1rem;">
  <div class="profile-section">
    <div class="section-header">
      <h2><i class="fas fa-list"></i> Sessions <span style="color:var(--text-secondary); font-weight:600;">({{ sessions|length }})</span></h2>
    </div>

    <div class="section-content">
      {% if sessions %}
        <div class="action-cards">
          {% for s in sessions %}
            <div id="session-{{ s.id }}" class="action-card">
              <div class="action-icon">
                <i class="fas fa-book-open"></i>
              </div>

              <div class="action-content">
                <h3>
                  {{ s.subject }}
                  {% if s.capacity == 1 %}
                    <span class="section-badge" style="margin-left:.5rem;">1-on-1</span>
                  {% else %}
                    <span class="section-badge" style="margin-left:.5rem;">Group ({{ s.capacity }})</span>
                  {% endif %}
                  {% if s.is_remote %}
                    <span class="section-badge" style="margin-left:.5rem; background:var(--bg-secondary); color:var(--text-secondary);">Remote</span>
                  {% endif %}
                </h3>

                <p style="margin-top:.35rem;">
                  <span style="color:var(--text-secondary);">
                    <i class="far fa-calendar"></i> {{ s.date }}
                    &nbsp;&nbsp; <i class="far fa-clock"></i>
                    {% if s.start_time %}{{ s.start_time }}{% else %}Any{% endif %}
                    ‚Äì
                    {% if s.end_time %}{{ s.end_time }}{% else %}Any{% endif %}
                    &nbsp;&nbsp; <i class="fas fa-map-marker-alt"></i> {{ s.location }}
                    &nbsp;&nbsp; <i class="fas fa-chalkboard-teacher"></i> {{ s.tutor.username }}
                    &nbsp;&nbsp; <i class="fas fa-users"></i> {{ s.seats_taken }} / {{ s.capacity }}
                  </span>
                </p>

                {% if s.description %}
                  <p style="margin-top:.35rem; color:var(--text-light);">{{ s.description }}</p>
                {% endif %}
              </div>

              <i class="fas fa-arrow-right action-arrow"></i>

              <div class="profile-actions" style="margin-left:auto;">
                {% if s.is_full %}
                  <button class="btn btn-outline-nav" disabled>Full</button>
                {% else %}
                  {% if user.is_authenticated %}
                    <form method="post" action="{% url 'tutoringsession:request' s.id %}">
                      {% csrf_token %}
                      
                      {% with req=s.requests|get_request_for:user %}
                        {% if req %}
                            {% if req.status == "pending" %}
                                <button class="btn btn-secondary" disabled>Pending</button>
                            {% elif req.status == "approved" %}
                                <button class="btn btn-success" disabled>Enrolled</button>
                            {% elif req.status == "declined" %}
                                <button class="btn btn-outline-nav" disabled>Declined</button>
                            {% endif %}
                        {% else %}
                            <form method="post" action="{% url 'tutoringsession:request' s.id %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-hand-paper"></i> Request Session
                                </button>
                            </form>
                        {% endif %}
                    {% endwith %}

                    </form>
                  {% else %}
                    <a class="btn btn-primary" href="{% url 'accounts:login' %}?next={% url 'tutoringsession:index' %}">
                      Log in to request
                    </a>
                  {% endif %}
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="empty-profile" style="padding:3rem 1.5rem;">
          <div class="empty-icon"><i class="far fa-calendar-times"></i></div>
          <h2>No sessions match your filters</h2>
          <p>Try broadening your search (different date/time or remove "Include full").</p>
          <div class="empty-actions">
            <a href="{% url 'tutoringsession:index' %}" class="btn btn-secondary">Clear Filters</a>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</section>

{% endblock %}